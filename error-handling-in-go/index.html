<!doctype html><html><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Chris Prijic's personal website."><link rel=apple-touch-icon sizes=180x180 href=/img/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/img/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/img/favicon-16x16.png><link rel=manifest href=/meta/site.webmanifest><link rel=stylesheet href=/css/style.min.css><title>Error Handling in Go</title><script async src="https://www.googletagmanager.com/gtag/js?id=UA-33625943-1"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","UA-33625943-1")</script></head><body><header id=banner><h2><a href=https://chrisprijic.com/>Chris Prijic</a></h2><nav><ul><li><a href=/ title=posts>posts</a></li></ul></nav></header><main id=content><article><header id=post-header><h1>Error Handling in Go</h1><div><time>May 22, 2022</time></div></header><p>I&rsquo;ve been using Go for five years now in both professional and personal
projects. This will be the first post of many where I look back at that
experience and analyze a particular part of the language, as well as share some
common patterns and lessons I&rsquo;ve learned along the way.</p><hr><p>In Go, errors are <em>values</em>. This means they can be returned, operated on, and
passed around like any other value. Errors as values provides some great
benefits:</p><ul><li>explicit control flow throughout your application</li><li>the ability to enrich errors with additional, human-readable information</li><li>there&rsquo;s no question if a method can error out or not</li></ul><p>They are a core language type that only have one requirement. TO be an error,
you must satisfy the following interface:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=kt>error</span> <span class=kd>interface</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>Error</span><span class=p>()</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>You have a couple of ways to easily create errors:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>err</span> <span class=p>=</span> <span class=nx>errors</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=s>&#34;this is a string --&gt; error&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>err</span> <span class=p>=</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;this does string formatting into an error: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span></code></pre></div><p>There&rsquo;s also error wrapping, introduced in Go 1.13<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>. This lets you add
additional context while also letting callers detect lower-level error types
easily and effectively.</p><h2 id=how-i-handle-errors-in-go>How I handle errors in Go</h2><p>Let&rsquo;s check out a practical (though simplified) example of copying a file
(lifted and modified from Russ Cox&rsquo;s Go 2 proposal<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup>):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>CopyFile</span><span class=p>(</span><span class=nx>src</span><span class=p>,</span> <span class=nx>dst</span> <span class=kt>string</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>r</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>os</span><span class=p>.</span><span class=nf>Open</span><span class=p>(</span><span class=nx>src</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;error opening src file %s: %w&#34;</span><span class=p>,</span> <span class=nx>src</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=nx>r</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>w</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>os</span><span class=p>.</span><span class=nf>Create</span><span class=p>(</span><span class=nx>dst</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;error creating dst file %s: %w&#34;</span><span class=p>,</span> <span class=nx>dst</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>io</span><span class=p>.</span><span class=nf>Copy</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=nx>r</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>w</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		<span class=nx>os</span><span class=p>.</span><span class=nf>Remove</span><span class=p>(</span><span class=nx>dst</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=s>&#34;error copying file contents from %s to %s: %w&#34;</span><span class=p>,</span> <span class=nx>src</span><span class=p>,</span> <span class=nx>dst</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>w</span><span class=p>.</span><span class=nf>Close</span><span class=p>();</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>os</span><span class=p>.</span><span class=nf>Remove</span><span class=p>(</span><span class=nx>dst</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;error closing dst file %s: %w&#34;</span><span class=p>,</span> <span class=nx>dst</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Here I modified the original code example with two changes:</p><ul><li>wrapping errors in <code>fmt.Errorf</code> using <code>%w</code></li><li>modifying the error messages to include context about <em>what</em> failed to happen</li></ul><p>If you&rsquo;re hacking or scripting, you can just log the error, but still get any
context you might want from the printed error:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>err</span> <span class=o>:=</span> <span class=nf>CopyFile</span><span class=p>(</span><span class=nx>src</span><span class=p>,</span> <span class=nx>dst</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>log</span><span class=p>.</span><span class=nf>Fatalf</span><span class=p>(</span><span class=s>&#34;Error: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Here&rsquo;s what a possible error prints out:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>error opening src file file.txt: open file.txt: no such file or directory
</span></span></code></pre></div><p>Not only does it log that it failed to find such a file or directory, but also
that it is the <em>source</em> file that couldn&rsquo;t be opened. What if you don&rsquo;t know if
the file was the source or destination file? The additional context added to the
error message clears that up for you.</p><p>Alternatively, in automated or production use-cases, you can handle specific
error types automatically with a little extra code:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>err</span> <span class=o>:=</span> <span class=nf>CopyFile</span><span class=p>(</span><span class=s>&#34;source.txt&#34;</span><span class=p>,</span> <span class=s>&#34;dest.txt&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>switch</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=nx>errors</span><span class=p>.</span><span class=nf>Is</span><span class=p>(</span><span class=nx>err</span><span class=p>,</span> <span class=nx>os</span><span class=p>.</span><span class=nx>ErrNotExist</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=c1>// handle missing file error directly
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// ... other cases
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h2 id=re-all-the-discourse-around-errors>Re: All the discourse around errors</h2><p>Go error handling is a somewhat devisive part of the language. You can easily
discover a variety of material online already that speak to the stark contrast
of those that like and dislike this feature of the language<sup id=fnref:3><a href=#fn:3 class=footnote-ref role=doc-noteref>3</a></sup>.</p><p>Many developers have issues with Go&rsquo;s error handling patterns. Common complaints
include the following (non-exhaustive) list:</p><ul><li><em>writing too much code for error handling</em>: To this, I say that we all spend
more time reading and understanding code, not writing it.</li><li><em>you keep copy/pasting the pattern <code>if err != nil {return err}</code></em> everywhere:
To this, I find explicit code flow to be easier to reason about and understand
than it automatically returning these errors instead.</li></ul><p>Let&rsquo;s take a quick look at that second point in a little more detail.</p><h2 id=bubbling-errors>Bubbling errors</h2><p>I find it paramount for users of Go to understand the importance of the
statement <code>if err != nil {return err}</code>. Here&rsquo;s why its so important.</p><p>First off, it tells you that whatever error is happening, the current code flow
is not willing or able to handle it. A great example is a circuit breaker
returning a <code>4XX</code> error.</p><p>In this example, a circuit breaker should not get in your way except to handle
the case that opens the circuit. If any other error should occur, it should
transparently return the original error without modification. It has no reason
nor purpose to modify a user-caused error.</p><p>If you want to add additional context to the error, you can use wrapping.You are
still sharing details about the original error by <em>wrapping</em> the error. Both
the returned erro ras well as the original error are available to the caller and
can be handled in whatever way is deemed fit for the situation.</p><h2 id=final-words>Final Words</h2><p>Error handling is a very challenging problem to tackle. Proper error handling
and reporting requires a lot of code and isn&rsquo;t easily solved using other error
handling techniques, like exception throwing and handling.</p><p>It might seem daunting to have a bunch of error checking and mapping throughout
your code; however, in practice I&rsquo;ve seen the opposite effect. What little
amount of additional code you have to write, you make up in the clarity of your
code&rsquo;s flow control, while also reducing your cognitive load on keeping track of
what the code is doing.</p><p>Let&rsquo;s look at Rust, which supports <code>Result&lt;T, E></code>, the <code>?</code> operator, and so on.
Though this still denotes areas of your code that return errors, it still adds
additional cognitive load to understand and model these concepts in your head,
rather than letting the code explicitly and plainly tell you what it is doing.</p><p>Go2&rsquo;s design proposal<sup id=fnref:4><a href=#fn:4 class=footnote-ref role=doc-noteref>4</a></sup> for error handling is interesting, but I still digress
that it focuses on reducing the effort tied to writing code, rather than the
overall cost of reading, understanding, and maintaining code. Go&rsquo;s error
handling helps you improve the base quality of the code, at the expense of a
little extra written code to accomplish that, and that&rsquo;s ok.</p><hr><h2 id=tldr>TL;DR:</h2><p>Overall, I apply the following guidelines for error handling in Go:</p><ul><li><strong>always</strong> handle errors. Never use <code>_</code>. Use <code>panic</code> if it isn&rsquo;t production or
mission critical.</li><li>expand if possible on what failed due to the error. Use <code>fmt.Errorf</code> with <code>%w</code></li><li>use 1.13 features of <code>Is</code>, <code>As</code>, and <code>Unwrap</code> to support more robust error
handling use-cases</li><li>focus more on the ability for your code to tell others what it does plainly,
without ambiguity. Writing a couple more lines, or copying a couple of lines
won&rsquo;t drastically derail a timeline to complete a project</li></ul><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p><a href=https://go.dev/doc/go1.13#error_wrapping>Go 1.13 Release Notes (Error Wrapping)</a>&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2><p><a href="https://www.youtube.com/watch?v=6wIP3rO6On8&t=131s">Go 2 Drafts Announcement</a>&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:3><p><a href=https://www.boramalper.org/blog/go-s-error-handling-sucks-a-quantitative-analysis/>Go&rsquo;s Error Handling Sucks</a>,
<a href=https://rauljordan.com/2020/07/06/why-go-error-handling-is-awesome.html>Why Go&rsquo;s Error Handling is Awesome</a>,
<a href=https://debugged.it/blog/go-is-terrible/>Go is a terrible language</a>&#160;<a href=#fnref:3 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:4><p><a href=https://go.googlesource.com/proposal/+/master/design/go2draft-error-handling-overview.md>Error Handling (Go2 Draft)</a>&#160;<a href=#fnref:4 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></article></main><footer id=footer><a href=https://twitter.com/chrisprijic>Twitter</a>
|
<a href=https://github.com/chrisprijic>Github</a></br>© 2022-present Chris Prijic (unless otherwise noted). Views are my own and do not necessarily reflect those of my employer.</br>All code is licensed under the
<a rel=license href=https://opensource.org/licenses/MIT>MIT License</a>;
other writing and media licensed under the
<a rel=license href=https://creativecommons.org/licenses/by-sa/4.0/>Creative Commons Attribution-Share-Alike 4.0 International License</a>.</br>Built with
<a href=https://gohugo.io/>Hugo</a>;
theme derived from
<a href=https://themes.gohugo.io/themes/etch/>Etch</a>.</footer></body></html>